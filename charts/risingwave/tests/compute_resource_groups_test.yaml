suite: Test compute resource groups
templates:
- compute-sts.yaml
chart:
  appVersion: 1.0.0
  version: 0.0.1
tests:
- it: renders multiple StatefulSets for resource groups
  set:
    computeComponent:
      resourceGroups:
        - name: group-a
          replicas: 2
        - name: group-b
          replicas: 5
        - name: group-c
          replicas: 6
  asserts:
  - documentIndex: 0
    containsDocument:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: RELEASE-NAME-risingwave-compute-group-a
  - documentIndex: 1
    containsDocument:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: RELEASE-NAME-risingwave-compute-group-b
  - documentIndex: 2
    containsDocument:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: RELEASE-NAME-risingwave-compute-group-c
  - documentIndex: 0
    equal:
      path: spec.replicas
      value: 2
  - documentIndex: 1
    equal:
      path: spec.replicas
      value: 5
  - documentIndex: 2
    equal:
      path: spec.replicas
      value: 6
  - documentIndex: 0
    equal:
      path: spec.template.spec.containers[0].env[0].name
      value: RW_RESOURCE_GROUP
  - documentIndex: 0
    equal:
      path: spec.template.spec.containers[0].env[0].value
      value: group-a
  - documentIndex: 1
    equal:
      path: spec.template.spec.containers[0].env[0].name
      value: RW_RESOURCE_GROUP
  - documentIndex: 1
    equal:
      path: spec.template.spec.containers[0].env[0].value
      value: group-b
  - documentIndex: 2
    equal:
      path: spec.template.spec.containers[0].env[0].name
      value: RW_RESOURCE_GROUP
  - documentIndex: 2
    equal:
      path: spec.template.spec.containers[0].env[0].value
      value: group-c
- it: falls back to old behavior if resourceGroups is empty
  set:
    computeComponent:
      resourceGroups: []
      replicas: 3
  asserts:
  - documentIndex: 0
    hasDocuments:
      count: 1
  - documentIndex: 0
    equal:
      path: spec.replicas
      value: 3
  - documentIndex: 0
    notExists:
      path: spec.template.spec.containers[?(@.name=="RW_RESOURCE_GROUP")] 
- it: keeps all original containers when resourceGroups is empty
  set:
    computeComponent:
      resourceGroups: []
      replicas: 2
      additionalContainers:
        - name: sidecar
          image: busybox
          command: ["sleep", "3600"]
    compactMode:
      enabled: true
  asserts:
    - documentIndex: 0
      lengthEqual:
        path: spec.template.spec.containers
        count: 3
    - documentIndex: 0
      exists:
        path: spec.template.spec.containers[?(@.name=="compute")]
    - documentIndex: 0
      exists:
        path: spec.template.spec.containers[?(@.name=="frontend")]
    - documentIndex: 0
      exists:
        path: spec.template.spec.containers[?(@.name=="sidecar")]